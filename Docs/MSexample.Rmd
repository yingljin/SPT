---
title: "Investigating MS Lesion Scans"
author: "Ying Jin"
date: "`r Sys.Date()`"
output: 
  html_document:
    self_contained: true
    number_sections: true
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: true
    font: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(neurobase) # https://cran.r-project.org/web/packages/neurobase/index.html
library(tidyverse)
library(here)
theme_set(theme_minimal())
```


```{r load_data}
# all
load(here("DataOutput/df_scans.RData"))


### File paths ####
# list.files("DataRaw")
paths <- read.csv(here("DataRaw/WM_lesion_QC_result.csv"))
# 82 scans
# 8 subjects
# 4 sites
# two scans each sites

#### Read processed image and segmentation ####
paths <- paths %>% 
  separate(., col=flair_files, 
           into = c(rep(NA, 8), "registration", "flair", "name1"),
           sep = "/") %>% 
  separate(., col=mimosa_files, 
           into = c(rep(NA, 8), "mimosa", "name2"),
           sep = "/") 

paths <- paths %>%
  mutate(subject = gsub("-", "", subject)) %>%
  mutate(
  file_path = paste0("DataRaw/processed/data/sub-", subject, "/ses-", session, 
                     "/", registration, "/", flair, "/", name1),
  seg_path =  paste0("DataRaw/processed/data/sub-", subject, "/ses-", session, 
                     "/", mimosa, "/", name2)
) 

```



```{r}
# let's use one subject as an example 
paths_01001 <- paths %>% filter(subject=="01001") 

# reading in and display
list_mat <- list()
list_img <- list()
list_seg_img <- list()
list_seg_mat <- list()
for(p in seq_along(paths_01001$file_path)){
  
  # image
  img_p <- readNIfTI(here(paths_01001$file_path[p]), reorient = F)
  list_img[[p]] <- img_p
  list_mat[[p]] <- img_p@.Data
  # segmentation
  seg_p <- readNIfTI(here(paths_01001$seg_path[p]), reorient = F)
  list_seg_img[[p]] <- seg_p
  list_seg_mat[[p]] <- seg_p@.Data
}
```


# Example of subject 01-001

## Whole images

Let's start by looking at the entire images. The lesion is only a very small part of it.

```{r BWH}
ortho2(x=list_img[[1]], y=list_seg_img[[1]], crosshair=FALSE,  
       text = paths_01001$session[1], 
       text.x=40, text.y = 10, text.cex = 1)
ortho2(x=list_img[[2]], y=list_seg_img[[2]], crosshair=FALSE,
       text = paths_01001$session[2], 
       text.x=40, text.y = 10, text.cex = 1)
```


```{r JHU}
ortho2(x=list_img[[3]], y=list_seg_img[[3]], crosshair=FALSE,  
       text = paths_01001$session[3], 
       text.x=40, text.y = 10, text.cex = 1)
ortho2(x=list_img[[4]], y=list_seg_img[[4]], crosshair=FALSE,
       text = paths_01001$session[4], 
       text.x=40, text.y = 10, text.cex = 1)
```


```{r NIH}
ortho2(x=list_img[[5]], y=list_seg_img[[5]], crosshair=FALSE,  
       text = paths_01001$session[5], 
       text.x=40, text.y = 10, text.cex = 1)
ortho2(x=list_img[[6]], y=list_seg_img[[6]], crosshair=FALSE,
       text = paths_01001$session[6], 
       text.x=40, text.y = 10, text.cex = 1)
```


```{r Penn}
ortho2(x=list_img[[7]], y=list_seg_img[[7]], crosshair=FALSE,  
       text = paths_01001$session[7], 
       text.x=40, text.y = 10, text.cex = 1)
ortho2(x=list_img[[8]], y=list_seg_img[[8]], crosshair=FALSE,
       text = paths_01001$session[8], 
       text.x=40, text.y = 10, text.cex = 1)
```

# Preliminary analysis 

The current plan is to study the correlation between scans within a specific area. Right now, I will use the area that is labeled as positive in both scans. 

Taking one subject as an example: 

1. first pick out pixels that is labeled positive in either scan.
2. Because scan across sites are so different in scale, let's standardize them. 
3. Calulate pearson correlation between scans from the same subject at the same site

```{r Scatter}
# pick out the pixels that are labeled as positive in either scan
df_scans <- df_scans %>% filter(seg==1)

# add a location index
df_scan_wide <- df_scans %>% group_by(id, site, scan) %>% 
  group_modify(~{.x %>% mutate(pixid = 1:nrow(.x))}) %>% 
  pivot_wider(names_from = scan,
              values_from = c(pix, seg)) 
```




```{r fig.height=32, fig.width=12}
df_scan_wide %>% 
  group_by(id, site) %>%
  mutate_at(c("pix_01", "pix_02"), scale) %>%
  # mutate_at(c("seg_01", "seg_02"), function(x){ifelse(is.na(x), 0, 1)}) %>%
  # mutate(colcode = as.factor(seg_01+seg_02)) %>% 
  ggplot(aes(x=pix_01, y=pix_02))+
  geom_point(size = 0.2, na.rm = T, alpha = 0.5)+
  geom_smooth(formula = y~x, method = "lm", na.rm = T)+
  ggpubr::stat_cor(cor.coef.name = "R", na.rm = T)+
  facet_grid(rows = vars(id), cols = vars(site))
```

The range of the Hopkins scans seem to be much larger than the other sites. 

