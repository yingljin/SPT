---
title: "Investigating MS Lesion Scans"
author: "Ying Jin"
date: "`r Sys.Date()`"
output: 
  html_document:
    self_contained: true
    number_sections: true
    code_folding: show
    toc: true
    toc_depth: 3
    toc_float: true
    font: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(neurobase) # https://cran.r-project.org/web/packages/neurobase/index.html
library(tidyverse)
library(here)
theme_set(theme_minimal())
```


```{r load_data}
# all
load(here("DataOutput/df_scans.RData"))


### File paths ####
# list.files("DataRaw")
paths <- read.csv(here("DataRaw/WM_lesion_QC_result.csv"))
# 82 scans
# 8 subjects
# 4 sites
# two scans each sites

#### Read processed image and segmentation ####
paths <- paths %>% 
  separate(., col=flair_files, 
           into = c(rep(NA, 8), "registration", "flair", "name1"),
           sep = "/") %>% 
  separate(., col=mimosa_files, 
           into = c(rep(NA, 8), "mimosa", "name2"),
           sep = "/") 

paths <- paths %>%
  mutate(subject = gsub("-", "", subject)) %>%
  mutate(
  file_path = paste0("DataRaw/processed/data/sub-", subject, "/ses-", session, 
                     "/", registration, "/", flair, "/", name1),
  seg_path =  paste0("DataRaw/processed/data/sub-", subject, "/ses-", session, 
                     "/", mimosa, "/", name2)
) 

```



```{r}
# let's use one subject as an example 
paths_01001 <- paths %>% filter(subject=="01001") 

# reading in and display
list_mat <- list()
list_img <- list()
list_seg_img <- list()
list_seg_mat <- list()
for(p in seq_along(paths_01001$file_path)){
  
  # image
  img_p <- readNIfTI(here(paths_01001$file_path[p]), reorient = F)
  list_img[[p]] <- img_p
  list_mat[[p]] <- img_p@.Data
  # segmentation
  seg_p <- readNIfTI(here(paths_01001$seg_path[p]), reorient = F)
  list_seg_img[[p]] <- seg_p
  list_seg_mat[[p]] <- seg_p@.Data
}
```


# Data

The image data was read in as two 3-D matrices. The first one contains the intensity values, the second binary flags, with one indicating a lesion voxel and zero a normal voxel. Please note that the lesion flag was obtained through a automatic segmentation process. As a consequence, there could be false positive flags.

Below is an example of one subject (01-001). Voxels labeled as lesion are marked out by red. 

```{r BWH}
ortho2(x=list_img[[1]], y=list_seg_img[[1]], crosshair=FALSE,  
       text = paths_01001$session[1], 
       text.x=40, text.y = 10, text.cex = 1)
ortho2(x=list_img[[2]], y=list_seg_img[[2]], crosshair=FALSE,
       text = paths_01001$session[2], 
       text.x=40, text.y = 10, text.cex = 1)
```


```{r JHU}
ortho2(x=list_img[[3]], y=list_seg_img[[3]], crosshair=FALSE,  
       text = paths_01001$session[3], 
       text.x=40, text.y = 10, text.cex = 1)
ortho2(x=list_img[[4]], y=list_seg_img[[4]], crosshair=FALSE,
       text = paths_01001$session[4], 
       text.x=40, text.y = 10, text.cex = 1)
```


```{r NIH}
ortho2(x=list_img[[5]], y=list_seg_img[[5]], crosshair=FALSE,  
       text = paths_01001$session[5], 
       text.x=40, text.y = 10, text.cex = 1)
ortho2(x=list_img[[6]], y=list_seg_img[[6]], crosshair=FALSE,
       text = paths_01001$session[6], 
       text.x=40, text.y = 10, text.cex = 1)
```


```{r Penn}
ortho2(x=list_img[[7]], y=list_seg_img[[7]], crosshair=FALSE,  
       text = paths_01001$session[7], 
       text.x=40, text.y = 10, text.cex = 1)
ortho2(x=list_img[[8]], y=list_seg_img[[8]], crosshair=FALSE,
       text = paths_01001$session[8], 
       text.x=40, text.y = 10, text.cex = 1)
```

# Preliminary analysis 

The current plan is to study the correlation between scans done at each specific area. A separate linear regression model of scan 2 on scan 1 is fit on each subject at each site, and only voxels that are labeled as "positive" in both scans are used in the regression.   

Below is a detailed procedure for regression on each subject at each site:

1. pick out voxels that are labeled positive in both scan.
2. standardize the intensity value 
3. fit regression a model calculate pearson correlation between scans from the same subject at the same site

```{r Scatter}
# pick out the pixels that are labeled as positive in either scan
df_scans <- df_scans %>% filter(seg==1)

# add a location index
df_scan_wide <- df_scans %>% group_by(id, site, scan) %>% 
  group_modify(~{.x %>% mutate(pixid = 1:nrow(.x))}) %>% 
  pivot_wider(names_from = scan,
              values_from = c(pix, seg))
```


Below is a display of the results. If any subject did not received a scan at any site, the corresponding figure is left empty. 


```{r fig.height=32, fig.width=12}
df_scan_wide %>% 
  group_by(id, site) %>%
  mutate_at(c("pix_01", "pix_02"), scale) %>%
  # mutate_at(c("seg_01", "seg_02"), function(x){ifelse(is.na(x), 0, 1)}) %>%
  # mutate(colcode = as.factor(seg_01+seg_02)) %>% 
  ggplot(aes(x=pix_01, y=pix_02))+
  geom_point(size = 0.2, na.rm = T, alpha = 0.5)+
  geom_smooth(formula = y~x, method = "lm", na.rm = T)+
  ggpubr::stat_cor(cor.coef.name = "R", na.rm = T)+
  facet_grid(rows = vars(id), cols = vars(site))+
  labs(y="Scan 2", x="Scan 1")
```

The major concern with this output is the lack of correlation across scans from the same subject at the same site. As the figure shows, the correlation value is very close two zero for most of these figures. 


<!-- # Cross-site regression -->

<!-- Regress one site on another site (pairwise) at given scan of the same subject. -->

<!-- But how can we do this? Scans at different sites does not have the same one-to-one relationship across voxels. Instead of the relationship between two matrices, this is more like testing the relationship between two distribution.  -->

<!-- Below is the distribution of standardized scan:  -->

<!-- ```{r} -->
<!-- df_scans %>%  -->
<!--   filter(id=="01001") %>% -->
<!--   group_by(scan, site) %>% -->
<!--   mutate(pix = scale(pix)) %>% -->
<!--   ggplot()+ -->
<!--   geom_histogram(aes(x=pix), bins = 30)+ -->
<!--   facet_grid(rows=vars(scan), cols = vars(site))+ -->
<!--   labs(title="Subject 01001") -->
<!-- ``` -->

```{r fig.height=32, fig.width=12, eval=FALSE}
# add a location index
# create wide data 
df_scan_wide2 <- df_scans %>% group_by(id, site, scan) %>% 
  group_modify(~{.x %>% mutate(pixid = 1:nrow(.x))}) %>% 
  pivot_wider(names_from = site,
              values_from = c(pix, seg)) 

```


```{r, fig.height=8, fig.width=2, eval=FALSE}
df_scan_wide2 %>% 
  group_by(id, scan) %>%
  mutate_at(vars(starts_with("pix_")), scale) %>%
  # mutate_at(c("seg_01", "seg_02"), function(x){ifelse(is.na(x), 0, 1)}) %>%
  # mutate(colcode = as.factor(seg_01+seg_02)) %>% 
  ggplot(aes(x=pix_BWH, y=pix_Hopkins))+
  geom_point(size = 0.2, na.rm = T, alpha = 0.5)+
  geom_smooth(formula = y~x, method = "lm", na.rm = T)+
  ggpubr::stat_cor(cor.coef.name = "R", na.rm = T)+
  facet_grid(rows = vars(id), cols = vars(scan))+
  labs("Hopkins ~ BWH")
```



